<meta charset="UTF-8">
<div data-role="page" id="userFriend">
	<link rel="stylesheet" type="text/css" href="userFriendlist.css" />
	<script id="userFriendTpl" type="text/x-jquery-tmpl">
	<li data-messageId="${idx}" friendId="${otherId}" id='talkItem_${idx}'>
		<h3>${otherId}</h3>
		<img src="${otherThumnail}">
		<div class="ui-li-aside">
			<p><strong>${regDate}</strong></p>
		</div>
			<p>${otherSex}</p>
			<p>${otherFrontComment}</p>

		<input type="button" class= ${state} value=" " id="testbtu">
	</li>
	</script>

	<script type="text/javascript">
		var sessionId;
		$("#userFriend").on("pageinit", function() {
			var params = {};
			//params.userId = $('#name').val();
			params.userId = "test46";
			sessionId = "test46";
			$("#id_header").html("@" + params.userId);
			getFriendList(params.userId);
			$("#user").live("click",function(){
				$.stageComponent.pageMove("blog2.html",{}, currentLoginId.userId);
	        });
			$("#ablum").live("click",function(){
				$.stageComponent.pageMove("camera.html",{}, currentLoginId.userId);
	        });
			$("#wall").live("click",function(){
				$.stageComponent.pageMove("wall.html",{}, currentLoginId.userId);
	        });
			
			$("#list").live("tap",function(){
				$(".overlay").show();
	        });
			
	        $(".ui-mobile-viewport").live("tap",function(event){
	            var target = event.target;
	            //Close the overlay if you have clicked on anywhere in body except the overlay itself and the button in header.
	            //If the check for button in this if is skipped,you will not be able to show the overlay.Clicking on button in header to close is //handled by previous event handler.
	            if($('#list').find(target).length==0 && $('.overlay').find(target).length==0) {
	                $(".overlay").hide();
	            }
	            
	        });
			
		});
		function reject_friend(id){
			
			var answer = confirm('거절하시겠습니까?');
			var url = $.stageRestPool.POST_USER_RELATION_SET_STATE;
			
			var params ={
		  			fromId: id,
		  			toId: sessionId
			}; 
			
			if(answer == true)
			{
				url+= $.stageRestPool.DENY_RELATION;
				$.stage.ajax.postJson(url, params, function(data) {
					alert("거절되었습니다");
					$("#request").empty();
					$("#friend").empty();
					getFriendList(sessionId);
				});
			}
		}
		function add_friend(id){
			var answer = confirm('승낙 하시겠습니까?');
			var url = $.stageRestPool.POST_USER_RELATION_SET_STATE;
			
			var params ={
		  			fromId: id,
		  			toId: sessionId
			}; 
			
			if(answer == true)
			{
				url+= $.stageRestPool.FRIEND_RELATION;
				$.stage.ajax.postJson(url, params, function(data) {
					alert("추가되었습니다");
					$("#request").empty();
					$("#friend").empty();
					getFriendList(sessionId);
				});
			}
		}
		function delete_friend(id){
			var answer = confirm('친구 삭제하시겠습니까?');
			var url = $.stageRestPool.POST_USER_RELATION_SET_STATE;
			
			var params ={
		  			fromId: id,
		  			toId: sessionId
			}; 
			
			if(answer == true)
			{
				url+= $.stageRestPool.NONE_RELATION;
				$.stage.ajax.postJson(url, params, function(data) {
					alert("삭제되었습니다");
					$("#request").empty();
					$("#friend").empty();
					getFriendList(sessionId);
				});
			}
		}
		function getFriendList(id) {
			var url = $.stageRestPool.USER_FRIEND_LIST;
			var params = {
				userId : id
			};

			$.stageAjax.getJson(url, params, function(result) {
				var a = 0;
				while (result.list[a] != null) {
					var img_src = result.list[a].otherThumnail;
					var comment = result.list[a].otherFrontComment;
					if (img_src == null)
						img_src = "gravatar.jpg";
					if(comment == null)
						comment=" ";
					if (result.list[a].state == 'R') {
						
						$("<div class='others'>").appendTo("#request").html('<div id="others_text"><font id="ID">'
										+ result.list[a].otherId
										+ '</font><br/><font>'
										+ comment
										+'</font><div class="reject_img"><img src="cssimage/delete_btu.png" onclick="reject_friend(id)" class="reject_fri" id='+result.list[a].otherId+'></div>'
										+'<div class="add_img"><img src="cssimage/chinchu_btn.png" onclick="add_friend(id)" class="add_fri" id='+result.list[a].otherId+'></div>'
										+ '</div><img src='+ img_src+' id="others_img">');

					} else if (result.list[a].state == 'F') {
						$("<div class='others'>").appendTo("#friend")
						.html('<div id="others_text"><font id="ID">'
										+ result.list[a].otherId
										+ '</font><br/><font>'
										+ comment
										+'</font><div class="delete_img"><img src="cssimage/delete_btu.png" onclick="delete_friend(id)" class="delete_fri" id='+result.list[a].otherId+'></div>'	
										+ '</div><img src='+ img_src+' id="others_img">');
					}
					a++;
				}

			});

		}
	</script>

	<header data-role="header" data-position="fixed"
		data-tap-toggle="false" id="header">
		<div id="back" class="ui-btn-left">
			<img src="cssimage/back_btn.png">
			<div id="line_left"></div>
		</div>
		<h1>친구 리스트</h1>

	</header>

	<div id="id_header"></div>

	<section data-role="content" id="content">

		<div id="req_title">Request Friends List</div>
		<div id="request"></div>

		<div id="fri_title">Friends List</div>
		<div id="friend"></div>

	</section>
	<div class="overlay" style="display: none">
		<div class="overlay-content">
			<ul id='tas_list' data-role='listview'>
				<li id="user">개인 정보</li>
				<li id="ablum">앨범</li>
				<li id="wall">담벼락</li>
			</ul>
		</div>
	</div>

	<footer data-role="footer" id="footer" data-position="fixed"
		data-tap-toggle="false">
		<ul>
			<li><a href="../talk/talkList.html" id="mainStalkButton"></a></li>
			<li><a href="blog.html" id="mainBlogButton"></a></li>
			<li><a href="../party/partyList.html" id="mainPartyButton"></a></li>
			<li><a href="camera.html" id="mainLoungeButton"></a></li>
			<li><a href="wall.html" id="mainSettingButton"></a></li>
		</ul>

	</footer>
</div>